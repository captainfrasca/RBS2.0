<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RBS 2.0 - ROV Training Module</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f1419;color:#fff;overflow:hidden;height:100vh;display:flex;flex-direction:column}
    .header{background:linear-gradient(135deg,#1a1f2e 0%,#2d3748 100%);padding:8px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #E30613;box-shadow:0 2px 10px rgba(0,0,0,.3)}
    .system-title{font-size:1.2em;font-weight:bold;color:#fff}
    .header-stats{display:flex;gap:15px}
    .stat-badge{display:flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-weight:bold;font-size:.85em}
    .stat-badge.critical{background:#e53e3e}.stat-badge.warning{background:#dd6b20}.stat-badge.ok{background:#38a169}
    .training-indicator{background:#f6ad55;padding:6px 16px;border-radius:20px;font-weight:bold;animation:pulseTraining 2s infinite}
    @keyframes pulseTraining{0%,100%{opacity:1}50%{opacity:.6}}

    .main-container{flex:1;display:grid;grid-template-columns:200px 1fr 380px;gap:8px;padding:8px;overflow:hidden}
    .sidebar{background:#1a202c;border-radius:8px;padding:10px;overflow-y:auto}
    .menu-item{padding:10px 12px;background:rgba(255,255,255,.05);border-radius:6px;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:8px;color:#a0aec0;font-size:.85em;margin-bottom:5px}
    .menu-item:hover{background:rgba(227,6,19,.2);color:#fff}
    .menu-item.active{background:#E30613;color:#fff}

    .center-content{background:#1a202c;border-radius:8px;overflow:hidden;display:flex;flex-direction:column}
    .workspace-tabs{display:flex;background:#2d3748;border-bottom:1px solid rgba(255,255,255,.1)}
    .workspace-tab{padding:10px 20px;cursor:pointer;transition:.3s;font-size:.9em;border-right:1px solid rgba(255,255,255,.1)}
    .workspace-tab:hover{background:rgba(227,6,19,.2)}
    .workspace-tab.active{background:#E30613;font-weight:bold}
    .workspace-content{flex:1;overflow:hidden;position:relative}

    #mapWrapper{position:relative;height:100%;width:100%}
    #mapContainer{position:absolute;inset:0}
    .map-overlay-info{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.8);padding:10px 15px;border-radius:8px;border:1px solid #E30613;z-index:1000;font-size:.85em}

    .conversation-view{height:100%;display:flex;flex-direction:column}
    .conversation-header{background:#2d3748;padding:15px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center}
    .caller-info{font-size:1.1em;font-weight:bold;color:#E30613}
    .call-timer{font-size:1.2em;font-weight:bold;color:#48bb78}
    .conversation-messages{flex:1;overflow-y:auto;padding:20px;background:#0f1419}
    .message{background:rgba(255,255,255,.05);padding:15px;border-radius:8px;margin-bottom:15px;border-left:3px solid #3182ce;animation:slideIn .3s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    .message.from-caller{border-left-color:#f6ad55}
    .message.from-rov{border-left-color:#48bb78;background:rgba(72,187,120,.1)}
    .message-sender{font-weight:bold;margin-bottom:5px;font-size:.9em;color:#a0aec0}
    .response-options{background:#1a202c;padding:20px;border-top:1px solid rgba(255,255,255,.1)}
    .response-btn{width:100%;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.2);color:#fff;padding:15px;border-radius:8px;cursor:pointer;text-align:left;transition:.3s;font-size:.95em;margin-bottom:10px}
    .response-btn:hover{background:rgba(227,6,19,.2);border-color:#E30613;transform:translateX(5px)}
    .response-btn.correct{background:rgba(72,187,120,.2);border-color:#48bb78}
    .response-btn.incorrect{background:rgba(229,62,62,.2);border-color:#e53e3e}
    .response-btn:disabled{cursor:not-allowed;opacity:.7}

    .right-panel{background:#1a202c;border-radius:8px;overflow:hidden;display:flex;flex-direction:column}
    .queue-header{background:#2d3748;padding:12px 15px;border-bottom:2px solid #E30613;display:flex;justify-content:space-between;align-items:center}
    .queue-title{font-weight:bold;font-size:1em;display:flex;align-items:center;gap:8px}
    .queue-count{background:#E30613;padding:2px 8px;border-radius:10px;font-size:.85em}
    .queue-list{flex:1;overflow-y:auto;padding:10px}
    .incident-card{background:rgba(255,255,255,.05);border-left:4px solid;padding:12px;margin-bottom:10px;border-radius:4px;cursor:pointer;transition:.3s;position:relative}
    .incident-card:hover{background:rgba(255,255,255,.08);transform:translateX(3px)}
    .incident-card.priority-1{border-left-color:#e53e3e;animation:urgentPulse 1.5s infinite}
    .incident-card.priority-2{border-left-color:#f6ad55}
    .incident-card.priority-3{border-left-color:#3182ce}
    @keyframes urgentPulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(229,62,62,0)}50%{opacity:.8;box-shadow:0 0 10px 2px rgba(229,62,62,.3)}}

    .incident-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
    .incident-type{background:rgba(227,6,19,.8);padding:2px 6px;border-radius:4px;font-size:.75em;font-weight:bold}
    .incident-time{font-size:.75em;color:#718096}
    .incident-title{font-weight:bold;margin-bottom:3px;font-size:.9em}
    .incident-location{font-size:.8em;color:#a0aec0}
    .accept-btn{margin-top:8px;padding:6px 12px;background:#48bb78;border:none;border-radius:4px;color:white;font-size:.85em;font-weight:bold;cursor:pointer;width:100%;transition:.3s}
    .accept-btn:hover{background:#38a169}
    .feedback{background:rgba(72,187,120,.1);border:1px solid #48bb78;padding:15px;border-radius:8px;margin-top:15px;animation:slideIn .3s ease-out}
    .feedback.negative{background:rgba(229,62,62,.1);border-color:#e53e3e}

    .waiting-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;color:#718096}
    .start-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px}
    .start-title{font-size:2.5em;font-weight:bold;color:#E30613;margin-bottom:20px}
    .start-description{font-size:1.1em;line-height:1.8;max-width:680px;margin-bottom:30px;color:#a0aec0}
    .start-btn{padding:15px 40px;background:#E30613;border:none;border-radius:8px;color:white;font-size:1.2em;font-weight:bold;cursor:pointer;transition:.3s}
    .start-btn:hover{background:#cc0510;transform:scale(1.05)}

    @keyframes slideInRight{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <div class="system-title">üöå RBS 2.0 - TRANSDEV COMMAND CENTER</div>
      <div class="training-indicator">TRAINING MODE</div>
    </div>
    <div class="header-stats">
      <div class="stat-badge ok"><span>‚úì</span><span id="activeCount">847</span><span>Actief</span></div>
      <div class="stat-badge warning"><span>‚ö†Ô∏è</span><span id="warningCount">23</span><span>Vertraagd</span></div>
      <div class="stat-badge critical"><span>üî¥</span><span id="criticalCount">0</span><span>Nood</span></div>
    </div>
    <div style="font-size:.85em;color:#a0aec0">
      <div style="font-weight:bold">Shift: <span id="shiftTime">00:00</span></div>
      <div>Score: <span id="score" style="color:#48bb78;font-weight:bold">0</span></div>
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <div class="menu-item active" onclick="setActiveMenu(this,'rov')"><span>üìû</span><span>ROV Training</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'dashboard')"><span>üìä</span><span>Dashboard</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'vehicles')"><span>üöå</span><span>Voertuigen</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'traffic')"><span>üö¶</span><span>Live Verkeer</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'routes')"><span>üìç</span><span>Routes</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'incidents')"><span>üö®</span><span>Incidenten</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'drivers')"><span>üë•</span><span>Chauffeurs</span></div>
      <div class="menu-item" onclick="setActiveMenu(this,'reports')"><span>üìä</span><span>Rapportages</span></div>
    </div>

    <div class="center-content">
      <div class="workspace-tabs">
        <div class="workspace-tab active" onclick="switchTab(this,'conversation')"><span>üìû Gesprek</span></div>
        <div class="workspace-tab" onclick="switchTab(this,'map')"><span>üó∫Ô∏è Kaart</span></div>
        <div class="workspace-tab" onclick="switchTab(this,'resources')"><span>üìã Resources</span></div>
      </div>
      <div class="workspace-content" id="workspaceContent"></div>
    </div>

    <div class="right-panel">
      <div class="queue-header">
        <div class="queue-title"><span>üö®</span><span>Wachtrij</span><span class="queue-count" id="queueCount">0</span></div>
      </div>
      <div class="queue-list" id="queueList"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---- Incident distributie & limieten
    const INCIDENT_WEIGHTS = { P1: 0.12, P2: 0.48, P3: 0.40 }; // ~12% P1
    const MAX_P1_IN_QUEUE = 1;              // max 1 wachtende P1
    const P1_COOLDOWN_MS  = 2 * 60 * 1000;  // min. 2 min tussen P1's

    // ---- Alarm (kan user gesture vereisen per browser)
    function playEmergencyAlarm(){
      try{const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return; const ctx=new Ctx();
        function tone(f,d,t){const o=ctx.createOscillator(),g=ctx.createGain();o.type='square';o.frequency.value=f;o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(.3,t);g.gain.exponentialRampToValueAtTime(.01,t+d);o.start(t);o.stop(t+d);} 
        const now=ctx.currentTime; tone(800,.2,now); tone(600,.2,now+.25); tone(800,.2,now+.5); tone(600,.2,now+.75);
      }catch(e){}
    }

    // ---- Voorbeeldincidenten (ingekort; voeg eigen extra's toe)
    const INCIDENTS={
      noodoproep1:{type:'NOOD',priority:1,caller:'Chauffeur Ahmed (Lijn 300)',title:'üö® MEDISCHE NOOD - REANIMATIE',location:'Haarlemmerplein, Amsterdam',coords:[52.3862,4.8769],conversation:[{sender:'Chauffeur',text:'ROV! SPOED! Passagier ligt op de grond, geen ademhaling! Iemand probeert te reanimeren!'}],responses:[{text:'Ahmed, laat direct 112 bellen! Ik schakel S&V in, MER onderweg, ritverval lijn 300 actief. Blijf bij slachtoffer!',correct:true,feedback:'Perfect! Alle noodprocedures direct ingezet.',points:150},{text:'Rij met spoed naar het dichtstbijzijnde ziekenhuis!',correct:false,feedback:'FOUT! Nooit vervoeren bij reanimatie. 112 ter plaatse!',points:-100},{text:'Is er een AED in de buurt? Ga die halen!',correct:false,feedback:'Verkeerde volgorde! Eerst 112, dan pas AED.',points:-50}].sort(()=>Math.random()-.5)},
      voertuigdefect1:{type:'VD',priority:2,caller:'Chauffeur Sarah (Lijn 300)',title:'Motor defect - A10',location:'A10 Noord',coords:[52.4014,4.9086],conversation:[{sender:'Chauffeur',text:'Motor afgeslagen op snelweg! Sta op vluchtstrook. 45 passagiers, sommigen in paniek.'}],responses:[{text:'Probeer de motor nog een paar keer.',correct:false,feedback:'Tijdverlies op gevaarlijke plek!',points:-20},{text:'Sarah: Waarschuwingslichten aan! MER met vervangbus onderweg. Monteur gealarmeerd. Rijkswaterstaat ingelicht. Ritverval actief. Houd passagiers rustig!',correct:true,feedback:'Uitstekend! Alle partijen ge√Ønformeerd, veiligheid voorop.',points:100},{text:'Laat iedereen uitstappen achter de vangrail.',correct:false,feedback:'Gevaarlijk op snelweg! Alleen bij direct gevaar.',points:-50}].sort(()=>Math.random()-.5)},
      busvol1:{type:'VV',priority:3,caller:'Chauffeur Kevin (Lijn 397)',title:'Overvolle bus Schiphol',location:'Schiphol Plaza',coords:[52.3105,4.7683],conversation:[{sender:'Chauffeur',text:'Stampvol! 30+ mensen blijven staan. Vlucht net geland, iedereen boos.'}],responses:[{text:'Check dienstregeling volgende 397. Bij >10min wachttijd: extra bus inzetten. Passagiers informeren. Noteer voor capaciteitsanalyse.',correct:true,feedback:'Goede aanpak! Service en data-analyse.',points:80},{text:'Ze moeten maar wachten.',correct:false,feedback:'Slechte service! Schiphol is prioriteit.',points:-40},{text:'Prop er nog wat mensen bij.',correct:false,feedback:'Illegaal en onveilig!',points:-80}].sort(()=>Math.random()-.5)}
    };

    class ROVTrainingSystem{
      constructor(){
        this.score=0; this.incidentsHandled=0; this.currentIncident=null; this.incidentQueue=[]; this.gameState='start'; this.startTime=null; this.stressLevel=0;
        this._mainTimerId=null; this._callTimerId=null; this._incidentTimerHandle=null; this.lastP1Time=0;
        // Map
        this.map=null; this.mapMarkers=[];
      }

      start(){ this.showStartScreen(); }

      showStartScreen(){
        const ws=document.getElementById('workspaceContent');
        ws.innerHTML=`<div class="start-screen">
          <div class="start-title">ROV Training - REALISTISCHE SHIFT</div>
          <div class="start-description"><strong>‚ö†Ô∏è</strong> Incidenten komen continu binnen. P1 wordt beperkt en gemaskeerd in de wachtrij/kaart. Bij oppakken tonen we direct ritgegevens.<br><br>
          Doel: handel ‚â•10 incidenten met zo min mogelijk fouten.</div>
          <button class="start-btn" onclick="game.startShift()">Start Shift</button>
        </div>`;
      }

      startShift(){
        this.gameState='playing'; this.startTime=Date.now();
        this.generateInitialIncidents();
        this._startIncidentStreamVariable();
        this.updateQueue(); this.showWaitingScreen(); this._startMainTimer();
      }

      // ---- Incident selectie (weighted, limiet, cooldown)
      _roulettePriority(){ const r=Math.random(); const p1=INCIDENT_WEIGHTS.P1; const p2=p1+INCIDENT_WEIGHTS.P2; if(r<p1) return 1; if(r<p2) return 2; return 3; }

      _startIncidentStreamVariable(){
        const scheduleNext=()=>{
          if(this.gameState!=='playing') return;
          const delay=15000+Math.random()*15000; // 15‚Äì30s
          this._incidentTimerHandle=setTimeout(()=>{
            if(this.incidentQueue.length<8){
              let desired=this._roulettePriority();
              const p1Wait=this.incidentQueue.filter(i=>i.priority===1).length;
              const tooSoon=(Date.now()-this.lastP1Time)<P1_COOLDOWN_MS;
              if(desired===1 && (p1Wait>=MAX_P1_IN_QUEUE || tooSoon)){
                desired=(Math.random()< (INCIDENT_WEIGHTS.P2/(INCIDENT_WEIGHTS.P2+INCIDENT_WEIGHTS.P3)))?2:3;
              }
              const pool=Object.keys(INCIDENTS).filter(k=>INCIDENTS[k].priority===desired);
              if(pool.length){ const k=pool[Math.floor(Math.random()*pool.length)]; this._addIncident(k); if(desired===1){ playEmergencyAlarm(); this.lastP1Time=Date.now(); this._notify('üö® NOODOPROEP BINNEN!',true); } else { this._notify('Nieuw incident in wachtrij'); } }
            }
            const urgentWaiting=this.incidentQueue.filter(i=>i.priority===1).length; if(urgentWaiting>0){ this.stressLevel+=urgentWaiting*5; this._updateStressIndicator(); }
            scheduleNext();
          },delay);
        };
        if(this._incidentTimerHandle) clearTimeout(this._incidentTimerHandle);
        scheduleNext();
      }

      generateInitialIncidents(){
        const keys=Object.keys(INCIDENTS); const want=3; let p1Added=0;
        for(let i=0;i<want;i++){
          let target=this._roulettePriority();
          if(target===1 && p1Added===1) target=2; // maximaal 1 P1 bij start
          const pool=keys.filter(k=>INCIDENTS[k].priority===target);
          if(!pool.length) continue; const k=pool[Math.floor(Math.random()*pool.length)];
          this._addIncident(k); if(target===1){ p1Added=1; this.lastP1Time=Date.now(); }
        }
      }

      _addIncident(key){ const inc={...INCIDENTS[key],id:'inc_'+Date.now()+'_'+Math.random().toString(36).slice(2,9),addedTime:Date.now()}; this.incidentQueue.push(inc); this._sortQueue(); this.updateQueue(); this._renderMarkers(); }
      _sortQueue(){ this.incidentQueue.sort((a,b)=>a.priority!==b.priority?a.priority-b.priority:a.addedTime-b.addedTime); }

      _notify(message,urgent=false){ const n=document.createElement('div'); n.style.cssText=`position:fixed;top:80px;right:20px;background:${urgent?'#e53e3e':'#E30613'};color:#fff;padding:15px 20px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.5);z-index:10000;font-weight:bold;animation:slideInRight .5s ${urgent?', urgentPulse 1s infinite':''}`; n.textContent=message; document.body.appendChild(n); setTimeout(()=>{n.style.opacity='0'; setTimeout(()=>n.remove(),500);},2500); }
      _updateStressIndicator(){ const critical=document.getElementById('criticalCount'); if(critical) critical.textContent=this.incidentQueue.filter(i=>i.priority===1).length; document.body.style.background=this.stressLevel>50?'#1a0a0a':'#0f1419'; }

      showWaitingScreen(){ const urgent=this.incidentQueue.filter(i=>i.priority===1).length; document.getElementById('workspaceContent').innerHTML=`<div class="waiting-screen"><div style="font-size:4em;color:${urgent>0?'#e53e3e':'#718096'}">üìû</div><h2>${urgent>0?'‚ö†Ô∏è '+urgent+' NOODOPROEP WACHT!':'Selecteer een incident'}</h2><p>Wachtrij: ${this.incidentQueue.length} incidenten</p></div>`; }

      updateQueue(){ const list=document.getElementById('queueList'); const count=document.getElementById('queueCount'); if(!list||!count) return; count.textContent=this.incidentQueue.length; if(this.incidentQueue.length===0){ list.innerHTML='<div style="text-align:center;color:#48bb78;padding:20px">‚úì Wachtrij leeg!</div>'; return; } const now=Date.now(); list.innerHTML=this.incidentQueue.map(inc=>{ const wt=Math.floor((now-inc.addedTime)/1000); const disp=wt>60?Math.floor(wt/60)+' min':wt+' sec'; const title = inc.priority===1 ? 'NOODOPROEP ‚Äì details onbekend' : inc.title; return `<div class="incident-card priority-${inc.priority}"><div class="incident-header"><span class="incident-type">${inc.type}</span><span class="incident-time" style="color:${wt>120?'#e53e3e':'#718096'}">‚è±Ô∏è ${disp}</span></div><div class="incident-title">${title}</div><div class="incident-location">üìç ${inc.location}</div><button class="accept-btn" onclick="game.acceptIncident('${inc.id}')">OPPAKKEN</button></div>`; }).join(''); }

      acceptIncident(id){ const inc=this.incidentQueue.find(i=>i.id===id); if(!inc) return; const p1Wait=this.incidentQueue.some(i=>i.priority===1); if(p1Wait && inc.priority>1){ if(!confirm('‚ö†Ô∏è Er wacht een NOODOPROEP! Toch deze melding oppakken?')) return; this.score-=50; this._notify('‚ö†Ô∏è -50 punten: Noodoproep genegeerd!',true); } this.currentIncident=inc; this.incidentQueue=this.incidentQueue.filter(i=>i.id!==id); this.updateQueue(); this.displayIncident(); if(inc.priority===1) playEmergencyAlarm(); this._renderMarkers(); }

      // ---- Ritgegevens helpers
      _parseLineNumber(str){ const m=/Lijn\s+(\d+)/i.exec(str||''); return m?m[1]:null; }
      _buildTripData(incident){ const lijn=this._parseLineNumber(incident.caller)||'‚Äî'; const now=new Date(); const pad=n=>String(n).padStart(2,'0'); const fmt=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`; const begin=new Date(now.getTime()-10*60000); const eind=new Date(now.getTime()+20*60000); return { lijn, rit:Math.floor(6000+Math.random()*500), beginTijd:fmt(begin), eindTijd:fmt(eind), startplaats:(incident.location.split(',')[0]||'‚Äî'), eindplaats:'Schiphol Noord', omloop:Math.floor(750000+Math.random()*200), dienstnr:Math.floor(1200000+Math.random()*999), chauffeur:incident.caller.replace('Chauffeur ','') , vestiging:'Schiphol Noord (ZB)', voertuig:'AVL VDL 18' }; }
      _renderTripCard(trip){ return `<div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px;margin:12px 20px 0;">
        <div style="display:flex;gap:12px;flex-wrap:wrap;font-size:.9em">
          <div><strong>Lijn</strong> ${trip.lijn}</div>
          <div><strong>Rit</strong> ${trip.rit}</div>
          <div><strong>Begin</strong> ${trip.beginTijd}</div>
          <div><strong>Einde</strong> ${trip.eindTijd}</div>
          <div><strong>Omloop</strong> ${trip.omloop}</div>
          <div><strong>Dienstnr</strong> ${trip.dienstnr}</div>
          <div><strong>Chauffeur</strong> ${trip.chauffeur}</div>
          <div><strong>Vestiging</strong> ${trip.vestiging}</div>
          <div><strong>Voertuig</strong> ${trip.voertuig}</div>
        </div>
        <div style="margin-top:6px;color:#a0aec0">${trip.startplaats} ‚Üí ${trip.eindplaats}</div>
      </div>`; }

      displayIncident(){ const inc=this.currentIncident; const ws=document.getElementById('workspaceContent'); if(!inc||!ws) return; const bg=inc.priority===1?'background:linear-gradient(135deg,#2a0a0a,#1a0a0a);':''; const trip=this._buildTripData(inc); ws.innerHTML=`<div class="conversation-view" style="${bg}"><div class="conversation-header" style="${inc.priority===1?'background:#8B0000;':''}"><div class="caller-info">${inc.priority===1?'üö® NOODOPROEP - ':''}${inc.caller}</div><div class="call-timer" id="callTimer">00:00</div></div>${this._renderTripCard(trip)}<div class="conversation-messages" id="convMessages">${inc.conversation.map(m=>`<div class=\"message from-caller\" style=\"${inc.priority===1?'border-left-color:#e53e3e;animation:urgentPulse 1s infinite;':''}\"><div class=\"message-sender\">${m.sender}</div><div style=\"font-size:${inc.priority===1?'1.1em':'1em'}\">${m.text}</div></div>`).join('')}</div><div class="response-options">${inc.responses.map((r,idx)=>`<button class=\"response-btn\" onclick=\"game.selectResponse(${idx})\">${r.text}</button>`).join('')}</div></div>`; this._startCallTimer(); }

      selectResponse(index){ const r=this.currentIncident.responses[index]; const respTime=Date.now()-this.currentIncident.addedTime; if(this.currentIncident.priority===1 && respTime>60000){ this.score-=25; this._notify('‚ö†Ô∏è -25 punten: Te trage response bij noodoproep!'); } this.score+=r.points; document.getElementById('score').textContent=this.score; document.querySelectorAll('.response-btn').forEach((b,i)=>{ b.disabled=true; if(this.currentIncident.responses[i].correct) b.classList.add('correct'); else if(i===index && !r.correct) b.classList.add('incorrect'); }); const box=document.getElementById('convMessages'); box.innerHTML+=`<div class="feedback ${r.correct?'':'negative'}" style="font-size:1.1em"><strong>${r.correct?'‚úì CORRECT PROTOCOL!':'‚úó FOUT PROTOCOL!'}</strong><br>${r.feedback}<br><strong>Punten: ${r.points>0?'+':''}${r.points}</strong></div>`; setTimeout(()=>{ document.querySelector('.response-options').innerHTML=`<button class="start-btn" onclick="game.nextIncident()">Volgende (${this.incidentQueue.length} wachtend)</button>`; },900); this.incidentsHandled++; this.updateQueue(); }

      _startCallTimer(){ if(this._callTimerId) clearInterval(this._callTimerId); const el=document.getElementById('callTimer'); const s=Date.now(); this._callTimerId=setInterval(()=>{ if(!this.currentIncident){clearInterval(this._callTimerId);return;} const e=Date.now()-s; const m=Math.floor(e/60000),sec=Math.floor((e%60000)/1000); el.textContent=String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); },1000); }

      nextIncident(){ this.currentIncident=null; if(this._callTimerId) clearInterval(this._callTimerId); if(this.incidentQueue.length>0) this.showWaitingScreen(); else if(this.incidentsHandled>=10) this.endShift(); else this.showWaitingScreen(); this._renderMarkers(); }

      _startMainTimer(){ if(this._mainTimerId) clearInterval(this._mainTimerId); this._mainTimerId=setInterval(()=>{ if(this.gameState!=='playing') return; const e=Date.now()-this.startTime; const m=Math.floor(e/60000),s=Math.floor((e%60000)/1000); document.getElementById('shiftTime').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); this.updateQueue(); },1000); }

      endShift(){ this.gameState='ended'; if(this._mainTimerId) clearInterval(this._mainTimerId); if(this._incidentTimerHandle) clearTimeout(this._incidentTimerHandle); if(this._callTimerId) clearInterval(this._callTimerId); const max=this.incidentsHandled*150; const pct=max?Math.round((this.score/max)*100):0; const grade=pct>=90?'A+':pct>=80?'A':pct>=70?'B':pct>=60?'C':'D'; const ws=document.getElementById('workspaceContent'); ws.innerHTML=`<div class="start-screen"><div class="start-title">SHIFT EVALUATIE</div><div style="font-size:3em;color:${(grade==='A+'||grade==='A')?'#48bb78':'#E30613'};margin:20px 0">${this.score} punten</div><div style="font-size:2em;margin-bottom:20px">Cijfer: ${grade}</div><div class="start-description"><strong>Statistieken:</strong><br>‚Ä¢ Incidenten afgehandeld: ${this.incidentsHandled}<br>‚Ä¢ Gemiddelde score: ${this.incidentsHandled?Math.round(this.score/this.incidentsHandled):0} per incident<br>‚Ä¢ Shift duur: ${Math.floor((Date.now()-this.startTime)/60000)} minuten<br></div><button class="start-btn" onclick="location.reload()">Nieuwe Shift</button></div>`; }

      // ---- Map
      showMap(){ const ws=document.getElementById('workspaceContent'); ws.innerHTML=`<div id="mapWrapper"><div id="mapContainer"></div><div class="map-overlay-info">P1/P2/P3 markers: rood/oranje/blauw. P1-titel gemaskeerd.</div></div>`; if(!this.map){ this.map=L.map('mapContainer',{zoomControl:true}); this.map.setView([52.2,5.3],8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap-bijdragers'}).addTo(this.map); } else { this.map.invalidateSize(); } this._renderMarkers(); }
      _renderMarkers(){ if(!this.map) return; this.mapMarkers.forEach(m=>this.map.removeLayer(m)); this.mapMarkers=[]; const all=[...this.incidentQueue]; if(this.currentIncident) all.push(this.currentIncident); all.forEach(inc=>{ const m=L.circleMarker(inc.coords,{radius:8,weight:2,fillOpacity:.8,color:inc.priority===1?'#e53e3e':inc.priority===2?'#f6ad55':'#3182ce'}).addTo(this.map); const puTitle = inc.priority===1 ? 'Noodoproep ‚Äì details onbekend' : inc.title; m.bindPopup(`<strong>${puTitle}</strong><br>${inc.location}<br><em>Prioriteit ${inc.priority}</em>`); m.on('click',()=>{ this.map.setView(inc.coords,14,{animate:true}); m.openPopup(); }); this.mapMarkers.push(m); }); }
    }

    let game;
    function setActiveMenu(el,section){ document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); if(section==='rov'){ if(!game) game=new ROVTrainingSystem(); game.start(); } else { document.getElementById('workspaceContent').innerHTML=`<div class="waiting-screen"><div style="font-size:3em">üõ†Ô∏è</div><p>"${section}" komt binnenkort‚Ä¶</p></div>`; } }
    function switchTab(el,tab){ document.querySelectorAll('.workspace-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); if(!game) return; if(tab==='map'){ game.showMap(); } else if(tab==='conversation'){ if(game.currentIncident) game.displayIncident(); else game.showWaitingScreen(); } else if(tab==='resources'){ document.getElementById('workspaceContent').innerHTML='<div class="waiting-screen"><div style="font-size:3em">üìã</div><p>Procedurekaarten & checklists volgen hier.</p></div>'; } }
    window.addEventListener('DOMContentLoaded',()=>{ game=new ROVTrainingSystem(); game.start(); });
  </script>
</body>
</html>
